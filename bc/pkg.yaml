name: bc
variant: scratch
dependencies:
  - stage: base
  - stage: bash
  - stage: texinfo
  - stage: perl
steps:
  - sources:
      - url: https://ftpmirror.gnu.org/gnu/bc/bc-{{ .bc_version }}.tar.gz
        destination: bc.tar.gz
        sha256: {{ .bc_sha256 }}
        sha512: {{ .bc_sha512 }}
    prepare:
      - |
        tar -xzf bc.tar.gz --strip-components=1

        cat > bc/fix-libmath_h << "EOF"
        #! /bin/bash
        sed -e '1   s/^/{"/' \
            -e     's/$/",/' \
            -e '2,$ s/^/"/'  \
            -e   '$ d'       \
            -i libmath.h

        sed -e '$ s/$/0}/' \
            -i libmath.h
        EOF

        sed -i -e '/flex/s/as_fn_error/: ;; # &/' ./configure

        mkdir build
        cd build
        ../configure \
            --prefix=/usr \
            --with-readline \
            --mandir=/usr/share/man \
            --infodir=/usr/share/info
    build:
      - |
        cd build
        make -j $(nproc)
    install:
      - |
        cd build
        make DESTDIR=/rootfs install
finalize:
  - from: /rootfs
    to: /
